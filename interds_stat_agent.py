#!/usr/bin/env python
# -*- coding: utf8 -*-
# __author__ = tliu


from lib.common_lib_nooracle import re_joint_dir_by_os, get_conf_pat, get_files_path
import time
import json
import urllib2
import datetime
import os


class NSConf:
    def __init__(self):
        ns_conf = re_joint_dir_by_os("conf|ns.ini")
        self.server_ip = get_conf_pat(ns_conf, "server", "ip")
        self.server_port = get_conf_pat(ns_conf, "server", "port")


def get_interds_stat(dsfile, capture_time_t, today_month_t):
    interds_data = {}

    with open(dsfile, 'r') as f:
        data_tmp = f.readlines()
        r = []

        for d in data_tmp[3:-2]:
            a = []
            tmp = filter(lambda x: x != '\n', ','.join(filter(lambda x: x, d.split(' '))))
            aa = tmp.split(',')
            # print "aaa:", aa
            if [''] != aa and ['\r'] != aa:
                DATATYPE = aa[1]

                ReadNum = aa[2]
                ResultNum = aa[3]
                ConDropNum = aa[4]

                OutSuccNum = aa[6]
                OutFailedNum = aa[7]
                OutDropNum = aa[8]
                a.append(DATATYPE)
                a.append(ReadNum)
                a.append(ResultNum)
                a.append(ConDropNum)
                a.append(OutSuccNum)
                a.append(OutFailedNum)
                a.append(OutDropNum)
                a.append(capture_time_t)
                a.append(today_month_t)
                r.append(a)
    interds_data['result_interds'] = r
    return interds_data

    # [['HTTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBCHAT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IMFRIENDCHAT', '2742', '2742', '0', '2742', '0', '0', 1503577560, '20170824'], ['DOMESTICTRAVELLER', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['GAME', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBBBS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['DVE_VOICE', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['DATA-DEVICEGSM=', '49', '49', '0', '49', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['HTTP', '11', '11', '0', '11', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['PHONEBOOK', '192', '192', '0', '192', '0', '0', 1503577560, '20170824'], ['WEBCHAT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBSHARE', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['AUTH', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBCHAT', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['DATA_LOCATION', '155', '155', '0', '155', '0', '0', 1503577560, '20170824'], ['IM', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['EMAIL', '11', '1', '10', '1', '0', '0', 1503577560, '20170824'], ['OTHER', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['NETLOG', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBBBS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FAVORITE', '26', '26', '0', '26', '0', '0', 1503577560, '20170824'], ['HTTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['PHONEBOOK', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['NEWS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['DATA_LOCATION', '155', '155', '0', '155', '0', '0', 1503577560, '20170824'], ['TERMINAL', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['IMFRIEND', '1020', '1018', '2', '1018', '0', '0', 1503577560, '20170824'], ['DATA-DEVICEIV', '20', '20', '0', '20', '0', '0', 1503577560, '20170824'], ['STREAMMEDIA', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WIFI', '35', '35', '0', '35', '0', '0', 1503577560, '20170824'], ['HTTPS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['HTTP', '498', '498', '0', '498', '0', '0', 1503577560, '20170824'], ['P2P', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['D', 'ATA-DEVICEWIFISCAN', '27', '27', 'STREAMPIPE', '27', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['GAME', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MMS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['GAME', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MRLOCATION', '781', '781', '0', '781', '0', '0', 1503577560, '20170824'], ['WEBBBS', '30', '30', '0', '30', '0', '0', 1503577560, '20170824'], ['VPN', '898', '898', '0', '898', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['SEARCH', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '1160', '1160', '0', '1160', '0', '0', 1503577560, '20170824'], ['WEBBBS', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['SEARCH', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBBBS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['NETLOG', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['GAME', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['COOKIES', '330', '330', '0', '330', '0', '0', 1503577560, '20170824'], ['PERSONRELATION', '5000', '5000', '0', '5000', '0', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBCHAT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IMGROUPMEMBER', '79', '79', '0', '79', '0', '0', 1503577560, '20170824'], ['EMAILACCOUNT', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MBLOGFRIEND', '103', '103', '0', '103', '0', '0', 1503577560, '20170824'], ['HTTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['EMAIL', '20', '0', '20', '0', '0', '0', 1503577560, '20170824'], ['RENT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['HTTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '3', '3', '0', '3', '0', '0', 1503577560, '20170824'], ['GAME', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WA_SOURCE_FJ_1001', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['SHOP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WA_SOURCE_FJ_1002', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBCHAT', '21', '21', '0', '21', '0', '0', 1503577560, '20170824'], ['EMAIL', '10', '0', '10', '0', '0', '0', 1503577560, '20170824'], ['WEBBBS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['EMAIL', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['WEBCHAT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['TRAINREALINFO', '20', '20', '0', '20', '0', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['BLOG', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '4', '4', '0', '4', '0', '0', 1503577560, '20170824'], ['OTHERPSW', '8', '8', '0', '8', '0', '0', 1503577560, '20170824'], ['MRSMS', '354', '354', '0', '354', '0', '0', 1503577560, '20170824'], ['WEBCHAT', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['DATA_LOCATION', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['GAME', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '49', '49', '0', '49', '0', '0', 1503577560, '20170824'], ['GAME', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['PHONEBOOK', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['HTTP', '3', '3', '0', '3', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MBLOGARTICLE', '26', '26', '0', '26', '0', '0', 1503577560, '20170824'], ['GAME', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['WEBBBS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['RENT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FLIGHT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MBLOGPRIVATE', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['BLOG', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['DATA-DEVICEAPP', '22', '22', '0', '22', '0', '0', 1503577560, '20170824'], ['EMAIL', '3', '3', '0', '3', '0', '0', 1503577560, '20170824'], ['HTTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MBLOGACCOUNT', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['IMACCOUNT', '14', '14', '0', '14', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['GROUPCHAT', '1077', '1077', '0', '1077', '0', '0', 1503577560, '20170824'], ['HTTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MBLOG', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['CALLLOG', '434', '434', '0', '434', '0', '0', 1503577560, '20170824'], ['MRHISTORY', '206', '206', '0', '206', '0', '0', 1503577560, '20170824'], ['BASE', '4', '4', '0', '4', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['TELNET', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MARRY', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['RECRUIT', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['TRAVELORDER', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MAP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['MBLOG', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['HARDWARESTRING', '498', '498', '0', '498', '0', '0', 1503577560, '20170824'], ['SIM', '4', '4', '0', '4', '0', '0', 1503577560, '20170824'], ['WA_SOURCE_FJ_1002', '175', '175', '0', '175', '0', '0', 1503577560, '20170824'], ['WA_SOURCE_FJ_1001', '682', '682', '0', '682', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['GAME', '2', '2', '0', '2', '0', '0', 1503577560, '20170824'], ['IMGROUP', '22', '22', '0', '22', '0', '0', 1503577560, '20170824'], ['EMAIL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['BASE-DEVICEWIFI', '7', '7', '0', '7', '0', '0', 1503577560, '20170824'], ['WEBBBS', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['IM', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['REMOTECTRL', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['AUTH', '1', '1', '0', '1', '0', '0', 1503577560, '20170824'], ['FTP', '1', '1', '0', '1', '0', '0', 1503577560, '20170824']] <type 'list'> 145


def put_interds_data(server_ip, server_port, interds_data):
    try:
        req = urllib2.Request("http://{IP}:{PORT}/updateinterds/".format(IP=server_ip, PORT=server_port), json.dumps(interds_data), {'Content-Type': 'application/json'})
        f = urllib2.urlopen(req)
        # response = f.readlines()
        # print response
        f.close()
    except Exception, e:
        print e


def main():
    apm = NSConf()

    # 删除结果目录中的历史
    path = '/home/NebulaSolarStat/'
    out_path = path + 'DSRunStat/out/'

    rm_com = "source /etc/profile;rm -rf {A}*".format(A=out_path)
    os.system(rm_com)

    # capture_time-1800,因为程序在当前小时第2分钟运行程序，处理的是上一个小时数据，
    # 所以capture_time需要配置为上一小时时间，1800为半小时，为确保capturetime为最大值，如果修改此工具执行周期，需要修改1800的值
    capture_time = int(time.time()) - 1800

    now_time = datetime.datetime.now()

    b1 = (now_time + datetime.timedelta(hours=-1)).strftime("%Y-%m-%d %H:00:00")
    b2 = (now_time + datetime.timedelta(hours=-1)).strftime("%Y-%m-%d %H:59:59")

    if int(str(now_time).split(" ")[1][0:2]) == 00:
        today_month = (now_time + datetime.timedelta(days=-1)).strftime("%Y%m%d")
        print "today_month:1:", today_month
    else:
        today_month = (now_time + datetime.timedelta()).strftime("%Y%m%d")
        print "today_month:2:", today_month


    # 执行脚本工具，检测一小时内中的数据
    # a = time.localtime(time.time())
    # b1 = time.strftime("%Y-%m-%d %H:00:00", a)
    # b2 = time.strftime("%Y-%m-%d %H:58:59", a)
    # do_com = "cd {P};sh bin/start.sh /home/nebula/inter_ds/fileprocess/log/dc/ 2017-08-16 00:00:00 2017-08-16 24:00:00".format(P="/home/NebulaSolarStat/DSRunStat/")
    do_com = "source /etc/profile;cd {P};sh bin/start.sh /home/nebula/inter_ds/fileprocess/log/dc/ {A} {B}".format(P="/home/NebulaSolarStat/DSRunStat/", A=b1, B=b2)
    print "do_com:", do_com
    os.system(do_com)


    #读取文件，取出所有数据
    dsfile = get_files_path(out_path, 'txt')
    # print "dsfile", dsfile
    # 检查文件是否存在
    if [] == dsfile:
        print "文件不存在，退出"
    else:
        interds_data = get_interds_stat(dsfile[0], capture_time, today_month)

        put_interds_data(apm.server_ip, apm.server_port, interds_data)

    # 将统计文件拷贝到bak目录


if __name__ == '__main__':
    main()


